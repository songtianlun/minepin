{{ define "content" }}

<form role="form" action="/pin/create" method="post">
  <div class="lead">新增一个图钉</div>
  <div class="raw">
    <div class="col-md-6">
      <div>
        <div class="form-group">
          <label for="suggestId">位置:</label>
          <input type="text" class="form-control" id="suggestId" name="location" />
        </div>
        <div class="form-group">
          <label for="longitude">经度:</label>
          <input type="text" class="form-control" id="longitude" name="longitude" />
        </div>
        <div class="form-group">
          <label for="latitude">纬度:</label>
          <input type="text" class="form-control" id="latitude" name="latitude" />
        </div>
        <div class="form-group">
          <label for="group">图钉组:</label>
          <select class="form-control" id="group" name="group">
            {{ range .Groups }}
            <option value="{{ .Id }}">{{ .Name }}</option>
            {{ end }}
          </select>
        </div>
        <div class="form-group">
          <label for="note">备注:</label>
          <input type="text" class="form-control" id="note" name="note" />
        </div>
        <div id="searchResultPanel"
             style="border:1px solid #C0C0C0;width:auto;height:auto; display:none;z-index:3"></div>
        <br/>
      </div>
    </div>
    <div class="col-md-6">
      <div id="l-map" style="margin: 20px auto;height: 300px;"></div>
    </div>
  </div>
  <button class="btn btn-lg btn-primary btn-block" type="submit">保存</button>
</form>

<script type="text/javascript" src="//api.map.baidu.com/api?type=webgl&v=2.0&ak={{ .BaiduAK }}"></script>
<script type="text/javascript">
  // 百度地图API功能
  function G(id) {
    return document.getElementById(id);
  }

  var map = new BMapGL.Map("l-map");
  map.centerAndZoom(new BMapGL.Point(116.404, 39.928), 15);
  // map.centerAndZoom("北京",12);                   // 初始化地图,设置城市和地图级别。
  map.enableScrollWheelZoom(true);
  // 增加点选事件，实现点选位置
  map.addEventListener('click', function (e) {
    // alert('点击位置经纬度：' + e.latlng.lng + ',' + e.latlng.lat);
    // var point = new BMapGL.Point( e.latlng.lng, e.latlng.lat);
    // var marker = new BMapGL.Marker(point);  // 创建标注
    // var opts = {
    //   width : 200,     // 信息窗口宽度
    //   height: 100,     // 信息窗口高度
    //   title : "经纬度" , // 信息窗口标题
    // }
    // var infoWindow = new BMapGL.InfoWindow('位置经纬度：' + e.latlng.lng + ',' + e.latlng.lat, opts);  // 创建信息窗口对象
    // marker.addEventListener("click", function(){
    //   map.openInfoWindow(infoWindow, point); //开启信息窗口
    // });
    // map.addOverlay(marker)
    map.clearOverlays()
    map.addOverlay(new BMapGL.Marker(new BMapGL.Point(e.latlng.lng, e.latlng.lat)));
    document.getElementById("longitude").value=e.latlng.lng
    document.getElementById("latitude").value=e.latlng.lat
  });

  var ac = new BMapGL.Autocomplete(    //建立一个自动完成的对象
          {"input" : "suggestId"
            ,"location" : map
          });

  ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
    var str = "";
    var _value = e.fromitem.value;
    var value = "";
    if (e.fromitem.index > -1) {
      value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
    }
    str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

    value = "";
    if (e.toitem.index > -1) {
      _value = e.toitem.value;
      value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
    }
    str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
    G("searchResultPanel").innerHTML = str;
  });

  var myValue;
  ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
    var _value = e.item.value;
    myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
    G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

    setPlace();
  });

  function setPlace(){
    map.clearOverlays();    //清除地图上所有覆盖物
    function myFun(){
      var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
      map.centerAndZoom(pp, 18);
      map.addOverlay(new BMapGL.Marker(pp));    //添加标注
      document.getElementById("longitude").value=pp.lng
      document.getElementById("latitude").value=pp.lat
    }
    var local = new BMapGL.LocalSearch(map, { //智能搜索
      onSearchComplete: myFun
    });
    local.search(myValue);
  }

  // 创建定位控件
  var locationControl = new BMapGL.LocationControl({
    // 控件的停靠位置（可选，默认左上角）
    anchor: BMAP_ANCHOR_TOP_RIGHT,
    // 控件基于停靠位置的偏移量（可选）
    offset: new BMapGL.Size(20, 20)
  });
  // 将控件添加到地图上
  map.addControl(locationControl);

  // 添加定位事件
  locationControl.addEventListener("locationSuccess", function(e){
    var address = '';
    address += e.addressComponent.province;
    address += e.addressComponent.city;
    address += e.addressComponent.district;
    address += e.addressComponent.street;
    address += e.addressComponent.streetNumber;
    alert("当前定位地址为：" + address);
  });
  locationControl.addEventListener("locationError",function(e){
    alert(e.message);
  });
</script>

{{ end }}